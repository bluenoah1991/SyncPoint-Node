{"version":3,"sources":["../src/HttpClient.js"],"names":["HttpClient","options","undefined","callback","scope","url","outgoing_address","incoming_address","httpPack","_pushStream","bind","response","status","error","Error","statusText","body","fetch","method","headers","credentials","then","_checkStatus","arrayBuffer","buffer","Buffer","Uint8Array","catch","reader","getReader","readChunk","read","newChunk","result","value","done","err","generateBody","requestBody","length","handle","setTimeout","_newRequest","_newLongRequest","chunk","startLongPolling","parseBody","payload","qos","commit"],"mappings":"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","file":"HttpClient.js","sourcesContent":["import _ from 'lodash';\n\nimport {HttpPack} from 'http-pack';\n\nexport default class HttpClient{\n    constructor(options){\n        if(options == undefined){\n            options = {};\n        }\n        this.callback = function(){};\n        this.scope = options['scope'] || 'user1';\n        this.url = options['url'] || 'http://example.com';\n        this.outgoing_address = options['outgoing_address'] || '/outgoing';\n        this.incoming_address = options['incoming_address'] || '/incoming';\n        this.httpPack = new HttpPack(options);\n        this._pushStream = this._pushStream.bind(this);\n    }\n\n    _checkStatus(response) {\n        if (response.status >= 200 && response.status < 300) {\n            return response;\n        } else {\n            let error = new Error(response.statusText);\n            error.response = response;\n            throw error;\n        }\n    }\n    \n    _newRequest(url, scope, body){\n        return fetch(url, {\n            method: 'POST',\n            body: body,\n            headers: {\n                'Content-Type': 'application/octet-stream',\n                'SyncPoint-Scope': scope\n            },\n            credentials: 'same-origin'\n        }).then(this._checkStatus).then(function(response){\n            return response.arrayBuffer().then(function(buffer){\n                // https://github.com/nodejs/node/issues/106\n                return new Buffer(new Uint8Array(buffer));\n            });\n        }).catch(function(error){\n            return null;\n        });\n    }\n    \n    _newLongRequest(url, scope, callback){\n        fetch(url, {\n            method: 'POST',\n            headers: {\n                'SyncPoint-Scope': scope\n            },\n            credentials: 'same-origin'\n        }).then(function(response){\n            let reader = response.body.getReader();\n            return readChunk();\n    \n            function readChunk(){\n                return reader.read().then(newChunk);\n            }\n    \n            function newChunk(result){\n                callback(false, result.value);\n                if(result.done){\n                    return true;\n                } else {\n                    return readChunk();\n                }\n            }\n        }).then(function(result){\n            callback(true, null);\n        }).catch(function(err){\n            callback(true, null);\n        });\n    }\n    \n    _pushStream(){\n        this.httpPack.generateBody().then(function(requestBody){\n            if(requestBody == undefined || requestBody.length == 0){\n                this.handle = setTimeout(this._pushStream, 100);\n                return null;\n            } else {\n                this._newRequest(`${this.url}${this.incoming_address}`, this.scope, requestBody).then(function(){\n                    this.handle = setTimeout(this._pushStream, 100);\n                }.bind(this));\n            }\n        }.bind(this));\n    }\n\n    registerCallback(callback){\n        this.callback = callback;\n    }\n\n    startLongPolling(){\n        this._newLongRequest(`${this.url}${this.outgoing_address}`, this.scope, function(done, chunk){\n            if(done){\n                setTimeout(this.startLongPolling.bind(this), 1000);\n                return;\n            }\n            this.httpPack.parseBody(chunk, this.callback.bind(this));\n        }.bind(this));\n    }\n\n    startPushStream(){\n        this.handle = setTimeout(this._pushStream, 1000);\n    }\n\n    commit(payload, qos){\n        return this.httpPack.commit(payload, qos);\n    }\n}"]}